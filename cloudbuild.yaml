steps:
# ─── Build & Push Ping-pong ──────────────────────────────────────────────────
- name: gcr.io/cloud-builders/docker
  dir: pingpong
  args: ["build","-t","gcr.io/$PROJECT_ID/pingpong:$SHORT_SHA","."]
- name: gcr.io/cloud-builders/docker
  args: ["push","gcr.io/$PROJECT_ID/pingpong:$SHORT_SHA"]

# ─── Build & Push Log-output ────────────────────────────────────────────────
- name: gcr.io/cloud-builders/docker
  dir: log-output
  args: ["build","-t","gcr.io/$PROJECT_ID/log-output:$SHORT_SHA","."]
- name: gcr.io/cloud-builders/docker
  args: ["push","gcr.io/$PROJECT_ID/log-output:$SHORT_SHA"]

# ─── Authenticate to GKE ─────────────────────────────────────────────────────
- name: gcr.io/cloud-builders/gcloud
  args:
    [
      "container","clusters","get-credentials","pingpong-cluster",
      "--zone=us-central1-a","--project=$PROJECT_ID"
    ]

# ─── Deploy new images ───────────────────────────────────────────────────────
- name: gcr.io/cloud-builders/kubectl
  args:
    [
      "set","image","deployment/pingpong-deployment",
      "pingpong=gcr.io/$PROJECT_ID/pingpong:$SHORT_SHA",
      "-n","my-project"
    ]
- name: gcr.io/cloud-builders/kubectl
  args:
    [
      "set","image","deployment/log-output",
      "log-output=gcr.io/$PROJECT_ID/log-output:$SHORT_SHA",
      "-n","my-project"
    ]

images:
- "gcr.io/$PROJECT_ID/pingpong:$SHORT_SHA"
- "gcr.io/$PROJECT_ID/log-output:$SHORT_SHA"
